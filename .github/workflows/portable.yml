name: Windows portable

on:
  push:
    tags:
      - v*.*.*

env:
  ffmpeg_archive_url: https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-n5.0-latest-win64-lgpl-shared-5.0.zip
  ffmpeg_archive_name: ffmpeg-n5.0-latest-win64-lgpl-shared-5.0.zip
  python_archive_url: https://www.python.org/ftp/python/3.10.4/python-3.10.4-embed-amd64.zip

jobs:

  build:
    name: Build Windows portable distributions
    runs-on: windows-latest 

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
        
      - name: Download ffmpeg archive
        # run: Invoke-WebRequest -Uri $($env:ffmpeg_archive_url) -OutFile ffmpeg.zip
        run: $pwd
        run: Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-n5.0-latest-win64-lgpl-shared-5.0.zip" -OutFile ffmpeg.zip
        run: Test-Path -Path ffmpeg.zip

      - name: Download python archive
        # run: Invoke-WebRequest -Uri $($env:python_archive_url) -OutFile python.zip
        run: Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.10.4/python-3.10.4-embed-amd64.zip" -OutFile python.zip
        run: Test-Path -Path python.zip

      - name: Create build directory and dist directory
        run: New-Item -Path @("build", "dist") -ItemType Directory

      - name: Enter build directory
        run: Set-Location -Path "build"

      - name: Unzip ffmpeg archive
        run: Expand-Archive -LiteralPath "..\ffmpeg.zip" -DestinationPath "."

      - name: Rename ffmpeg directory
        # run: Rename-Item -Path $($env:ffmpeg_archive).Substring(0, $($env:ffmpeg_archive).Length - 4) "ffmpeg"
        run: Rename-Item -Path ffmpeg-n5.0-latest-win64-lgpl-shared-5.0 "ffmpeg"

      - name: Sliming ffmpeg
        run: Get-ChildItem "ffmpeg" -Exclude @("LICENSE.txt", "bin") | Remove-Item -Recurse

      - name: Unzip Python archive
        run: Expand-Archive -LiteralPath "..\python.zip" -DestinationPath "python"

      - name: Create venv 
        run: python -m venv venv

      - name: Activate venv 
        run: .\venv\Scripts\activate
      
      - name: Install packages
        run: pip install ${{ github.workspace }}

      - name: Copy site-packages
        run: robocopy venv\Lib\site-packages python\Lib\site-packages /mir /xd __pycache__* pip* setuptools*

      - name: Add search path
        run: Add-Content -Path "python\python310._pth" "Lib\site-packages"

      - name: Copy run.bat
        run: Copy-Item "${{ github.workspace }}\run.bat" -Destination ".\run.bat"

      - name: Remove venv
        run: Remove-Item -Path "venv" -Recurse -Force

      - name: Exit build directory
        run: Set-Location -Path ".."

      - name: Zip files
        run: Compress-Archive -Path "build\*" -DestinationPath "dist\blrec-${{ github.ref_name }}-win64.zip"
